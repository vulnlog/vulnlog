package ch.addere.vulnlog.dsl

import ch.addere.vulnlog.core.model.reporter.VlReporter
import ch.addere.vulnlog.core.model.resolution.VlFixInResolution
import ch.addere.vulnlog.core.model.resolution.VlMitigateResolution
import ch.addere.vulnlog.core.model.resolution.VlResolutionVersionSet
import ch.addere.vulnlog.core.model.resolution.VlSuppressResolution
import ch.addere.vulnlog.core.model.version.VlVersion

class VlVulnerabilityBlock : VlStructure(), VlReport {
    var reporters = mutableSetOf<VlReporter>()
    var fixedInVersions: VlFixInResolution? = null
    var mitigateVersions: VlMitigateResolution? = null
    var suppressVersions: VlSuppressResolution? = null

    fun fixIn(
        vararg version: VlVersion,
        rationale: String = "",
    ) {
        val resolutionVersionSet = VlResolutionVersionSet(version.toSet())
        fixedInVersions = VlFixInResolution(resolutionVersionSet, rationale)
    }

    fun suppress(
        vararg version: VlVersion,
        rationale: String = "",
    ) {
        val resolutionVersionSet = VlResolutionVersionSet(version.toSet())
        suppressVersions = VlSuppressResolution(resolutionVersionSet, rationale)
    }

    fun mitigate(
        vararg version: VlVersion,
        rationale: String = "",
    ) {
        val resolutionVersionSet = VlResolutionVersionSet(version.toSet())
        mitigateVersions = VlMitigateResolution(resolutionVersionSet, rationale)
    }

    override fun affectedVersions(vararg affectedVersions: VlVersion) {
        reporters += DslGenericReporter(*affectedVersions).createReporter()
    }

    override fun owasp(vararg affectedVersions: VlVersion) {
        reporters += DslOwaspReporter(*affectedVersions).createReporter()
    }

    override fun snyk(
        snykId: String,
        vararg affectedVersions: VlVersion,
        init: (VlSnykBlock.() -> Unit)?,
    ) {
        reporters += DslSnykReporter(snykId, *affectedVersions, init = init).createReporter()
    }
}
