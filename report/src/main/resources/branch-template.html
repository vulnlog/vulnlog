<!DOCTYPE html>
<html lang='en'>
<head>
    <title>Vulnlog Reporting</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Vulnlog vulnerability report for release branch x.y.">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bulma/1.0.1/css/bulma.min.css" rel="stylesheet"
          integrity="sha384-u1DpPo/VC1cCewPdLA1ujElPdm1c/ZVa5MNAV6930PlrYYXhoKH/+hui6tE7szxu" crossorigin="anonymous">
    <link href="https://cdn.datatables.net/v/bm/jq-3.7.0/dt-2.2.2/datatables.min.css" rel="stylesheet"
          integrity="sha384-NQR9ysESFMRrrks4rwDgTlpUgpKPftZV/S48q+tang2oiEqMIFGM4VDLBYAYdNLc" crossorigin="anonymous">
    <script src="https://cdn.datatables.net/v/bm/jq-3.7.0/dt-2.2.2/datatables.min.js"
            integrity="sha384-SZXx6mFkCRJyGW8C8nsVaJpL1eMbIWwRRly7435CnZNwoIdr1QE2NpCihEcTIaM7"
            crossorigin="anonymous"></script>
    <script>
        let prefers = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        let html = document.querySelector('html');

        html.classList.add(prefers);
        html.setAttribute('data-bs-theme', prefers);
    </script>
    <!-- report-data -->
    <!-- vuln-data -->
</head>
<body>
<header>
    <section class="section">
        <div class="container mb-5">
            <h1 class="title is-1">Vulnlog Report</h1>
        </div>
        <div class="container">
            <p>Report for <em><span id="releaseBranch"></span></em> generated on <em><span
                    id="generationDate"></span></em></p>
        </div>
    </section>
</header>
<main>
    <section class="section">
        <div class="container">
            <h2 class="title is-3">Vulnerabilities</h2>
        </div>
        <div class="container">
            <table id="example" class="table is-hoverable">
                <thead>
                <tr>
                    <th>ID</th>
                    <th title="The impact the vulnerability may have on the software">Rating</th>
                    <th title="Reasoning behind the rating">Reasoning</th>
                    <th title="What is necessary to get rid of this vulnerability report">Task</th>
                    <th title="What verions are affected by the vulnerability">Affected</th>
                    <th title="In what version the vulnerability is planed to be fixed">Fix</th>
                    <th></th>
                </tr>
                </thead>
            </table>
        </div>
    </section>
</main>
<footer class="footer">
    <div class="container has-text-centered">
        <p>
            <!-- report-footer -->. Visit <a href="https://vulnlog.dev" target="_blank">vulnlog.dev</a> for more
            information.
        </p>
    </div>
</footer>
<script>
    let reportData = JSON.parse(document.getElementById('report-data').innerHTML);
    document.getElementById("releaseBranch").innerText = reportData.releaseBranchName
    document.getElementById("generationDate").innerText = reportData.generationDate

    let unifiedVulnerabilityData2 = JSON.parse(document.getElementById('vuln-data').innerHTML);
    let vulns = unifiedVulnerabilityData2.releaseBrancheVulnerabilities[0].vulnerabilities

    function format(d) {
        let id = d.ids.join((', '))
        let reporter = d.report.analyser
        let reporterDate = d.report.awareAt

        return (
            '<div class="columns">' +
            '<div class="column">' + '<p>ID: ' + id + '</p>' + '</div>' +
            '<div class="column">' + '<p>Reporter: ' + reporter + ' / ' + reporterDate + '</p></div>' +
            '<div class="column">' + '<p>Analysis</p>' + '</div>' +
            '<div class="column">' + '<p>Task</p>' + '</div>' +
            '<div class="column">' + '<p>Execution</p>' + '</div>' +
            '<div class="column">' + '<p>Involved</p>' + '</div>' +
            '</div>'
        );
    }

    let table = new DataTable('#example', {
        columns: [
            {
                data: 'ids',
                render: function (data, type) {
                    let result = ""
                    if (type === 'display') {
                        result = data[0]
                    } else if (type === 'filter') {
                        result = data.join((' '))
                    }
                    return result
                }
            },
            {
                data: 'analysis.verdict',
                render: function (data, type) {
                    if (type === 'display' || type === 'filter') {
                        switch (data) {
                            case "":
                                return 'under investigation'
                            case "not affected":
                                return 'ðŸŸ© not affected'
                            case "low":
                                return 'ðŸŸ¦ low'
                            case "moderate":
                                return 'ðŸŸ¨ moderate'
                            case "high":
                                return 'ðŸŸ§ high'
                            case "critical":
                                return 'ðŸŸ¥ critical'
                        }
                    }
                    switch (data) {
                        case "":
                            return "f"
                        case "not affected":
                            return "a"
                        case "low":
                            return "b"
                        case "moderate":
                            return "c"
                        case "high":
                            return "d"
                        case "critical":
                            return "e"
                    }
                },
            },
            {data: 'analysis.reasoning'},
            {
                data: 'task',
                render: data => data.action + ' ' + data.details.join(' ')
            },
            {
                data: 'involved',
                render: function (data) {
                    let publicationData = data.affectedReleaseVersion.publicationDate
                    let text = data.affectedReleaseVersion.version
                    if (publicationData) {
                        text += ' / ' + publicationData
                    }
                    return text
                }
            },
            {
                data: 'involved',
                render: function (data) {
                    let text = data.fixedReleaseVersion.version
                    let publicationData = data.fixedReleaseVersion.publicationDate
                    if (publicationData) {
                        text += ' / ' + publicationData
                    }
                    return text
                }
            },
            {
                // className: 'dt-control',
                className: 'dt-control',
                orderable: false,
                data: null,
                defaultContent: '',
            },
        ],
        data: vulns,
        order:
            [[1, 'desc']],
        paging:
            false,
    });

    table.on('click', 'td.dt-control', function (e) {
        let tr = e.target.closest('tr');
        let row = table.row(tr);

        if (row.child.isShown()) {
            row.child.hide();
        } else {
            row.child(format(row.data())).show();
        }
    });
</script>
</body>
</html>
